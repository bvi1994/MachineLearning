define("bundles/cml/components/CMLEditor",["require","exports","module","underscore","classnames","react","react-dom","react-bootstrap","bundles/cml/models/CMLToHTMLConverter","bundles/cml/models/HTMLToCMLConverter","bundles/cml/utils/CMLUtils","bundles/cml/utils/ScribeUtils","bundles/cml/propTypes/cml","bundles/phoenix/lib/placeCaretAtEnd","bundles/cml/components/CMLEditorToolbar","bundles/cml/constants/CMLEditorBlocks","i18n!nls/cml","js/lib/coursera.react-intl","css!./__styles__/CMLEditor"],function(require,exports,module){"use strict";function _defaults(e,s){for(var r=Object.getOwnPropertyNames(s),t=0;t<r.length;t++){var o=r[t],n=Object.getOwnPropertyDescriptor(s,o);n&&n.configurable&&void 0===e[o]&&Object.defineProperty(e,o,n)}return e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):_defaults(t,e))}var s,r,_=require("underscore"),U=require("classnames"),e=require("react"),o=require("react-dom"),i=require("react-bootstrap"),a=i.Tooltip,p=i.OverlayTrigger,d=require("bundles/cml/models/CMLToHTMLConverter"),u=require("bundles/cml/models/HTMLToCMLConverter"),n=require("bundles/cml/utils/CMLUtils"),c=require("bundles/cml/utils/ScribeUtils"),b=require("bundles/cml/propTypes/cml"),h=require("bundles/phoenix/lib/placeCaretAtEnd"),m=require("bundles/cml/components/CMLEditorToolbar"),t=require("bundles/cml/constants/CMLEditorBlocks"),f=t.H1,y=t.H2,g=t.H3,C=t.Bold,T=t.Italic,M=t.Underline,v=t.Divider,L=t.Link,O=t.OrderedList,P=t.UnorderedList,E=t.Image,k=t.Table,D=t.Code,H=require("i18n!nls/cml"),j=require("js/lib/coursera.react-intl"),w=j.FormattedHTMLMessage,l=function getHTML(t,o){var s=n.getValue(o),e="";try{e=t.toHTML(s)}catch(r){e=""}return""===e&&(e="<p></p>"),e};require("css!./__styles__/CMLEditor");var B=(r=s=function(t){function CMLEditor(){var r,e,i;_classCallCheck(this,CMLEditor);for(var c=arguments.length,l=Array(c),s=0;c>s;s++)l[s]=arguments[s];return r=e=_possibleConstructorReturn(this,t.call.apply(t,[this].concat(l))),e.handleChange=function(){var t=e.scribe.getHTML();e.acceptChanges&&e.currentHTML!==t&&(e.currentHTML=t,e.props.onKeyPress(),e.changeHandler())},e.changeHandler=function(){var t=e.htmlConverter.toCML(e.currentHTML,!0),o=n.getDtdId(e.props.cml),s=n.create(t,o);e.props.onChange(s,e.currentHTML)},e.focus=function(){h(o.findDOMNode(e.refs.editor))},i=r,_possibleConstructorReturn(e,i)}return _inherits(CMLEditor,t),CMLEditor.prototype.componentWillMount=function componentWillMount(){var e=this;this.converter=new d,this.htmlConverter=new u,this.converter.on("assetsAvailable",function(){var t=l(e.converter,e.props.cml);e.scribe.setContent(t)}),this.unsupportedBlocks=n.getUnsupportedBlocks(this.props.cml),this.isDisabled=0!==this.unsupportedBlocks.length,this.changeHandler=_(this.changeHandler).debounce(this.props.changeDelay)},CMLEditor.prototype.componentDidMount=function componentDidMount(){var d=this,e=this.props,s=e.blocks,r=e.placeholder,i=e.disabledPlugins,a=e.imageUploadOptions,p=e.assetAdminOptions,n=e.codeBlockOptions,u=o.findDOMNode(this.refs.editor),b=o.findDOMNode(this),h=o.findDOMNode(this.refs.toolbar),m=this.props.isFocused&&!this.isDisabled,t=l(this.converter,this.props.cml),y=this.handleChange,f={el:u,content:t,blocks:s,placeholder:r,disabledPlugins:i,imageUploadOptions:a,assetAdminOptions:p,codeBlockOptions:n,showToolbarByDefault:m,onContentChange:y,editorContainer:b,toolbarContainer:h};this.scribe=c.createInstance(f),this.scribe.setContent(t),this.props.isFocused&&!this.isDisabled&&(this.focus(),this.scribe.trigger("content-changed")),setTimeout(function(){return d.acceptChanges=!0},0)},CMLEditor.prototype.componentDidUpdate=function componentDidUpdate(e,t){e.isFocused||!this.props.isFocused||this.isDisabled||this.focus()},CMLEditor.prototype.componentWillUnmount=function componentWillUnmount(){c.destroyInstance(this.scribe)},CMLEditor.prototype.render=function render(){var t=this.isDisabled,o=this.props,s=o.blocks,r=o.toolbarStyle,n=e.createElement("div",{className:"rc-CMLEditor"},e.createElement("div",{id:this.props.id,ref:"editor",contentEditable:!0,className:U("scribe-editor",{disabled:t})}),e.createElement(m,{ref:"toolbar",blocks:s,style:r}));if(t){var i=e.createElement(a,null,e.createElement(w,{message:H("\n              This field contains unsupported object(s) <strong>{blockNames}</strong> and cannot be edited here.\n            "),blockNames:_(this.unsupportedBlocks).map(function(e){return e.nodeName.toLowerCase()}).join(", ")}));return e.createElement(p,{placement:"bottom",overlay:i},n)}return n},CMLEditor}(e.Component),s.propTypes={id:e.PropTypes.string,cml:b.isRequired,blocks:e.PropTypes.array,isFocused:e.PropTypes.bool,placeholder:e.PropTypes.string,changeDelay:e.PropTypes.number,disabledPlugins:e.PropTypes.array,toolbarStyle:e.PropTypes.object,assetAdminOptions:e.PropTypes.object,imageUploadOptions:e.PropTypes.object,codeBlockOptions:e.PropTypes.object,onKeyPress:e.PropTypes.func,onChange:e.PropTypes.func},s.defaultProps={blocks:[f,y,g,C,T,M,v,L,O,P,E,k,D],placeholder:"",changeDelay:500,toolbarStyle:{},disabledPlugins:[],onKeyPress:function onKeyPress(){},onChange:function onChange(){}},r);module.exports=B});