define("bundles/scribe-plugins/scribe-plugin-code-command",["require","exports","module","jquery","underscore","react","react-dom","lazy!bundles/phoenix/models/AceEditor","bundles/scribe-plugins/scribe-plugin-code-command/models/CodeIndexer","bundles/scribe-plugins/scribe-plugin-code-command/components/ScribeCodeEditor","bundles/scribe-plugins/scribe-plugin-code-command/components/ScribeCodeEditorLanguagePicker","bundles/scribe-plugins/scribe-utils"],function(require,exports,module){"use strict";var $=require("jquery"),_=require("underscore"),n=require("react"),e=require("react-dom"),r=require("lazy!bundles/phoenix/models/AceEditor"),i=require("bundles/scribe-plugins/scribe-plugin-code-command/models/CodeIndexer"),a=require("bundles/scribe-plugins/scribe-plugin-code-command/components/ScribeCodeEditor"),c=require("bundles/scribe-plugins/scribe-plugin-code-command/components/ScribeCodeEditorLanguagePicker"),t=require("bundles/scribe-plugins/scribe-utils"),d=t.findBlockContainer,u=t.isEmptyParagraphBlock,o="scribe-plugin-code-command";module.exports=function(l){var m=l.editorContainer,t=l.codeBlockOptions,s=m;return function(l){var f=null,p=null,m=null,b=new l.api.SimpleCommand("code","CODE"),g=new i(l),A=function handleBlockRemove(e){l.transactionManager.run(function(){return g.getCodeElementAtIndex(e).remove()})},S=function handleBlockChange(n,i,t,o){var r=g.getAceEditorAtIndex(n),e=g.getCodeElementAtIndex(n);r.setValue(t),r.setLanguage(o||""),l.transactionManager.run(function(){e.textContent=t,e.setAttribute("data-language",o||""),e.setAttribute("data-evaluator-id",i||"")})},v=function positionAndSizeEditor(t,e){var r=e.offsetTop,i=e.offsetLeft,a=e.offsetWidth,n=t.el.parentNode;n.style.position="absolute",n.style.top=r+2+"px",n.style.left=i+2+"px",n.style.width=a-2+"px";var c=t.resizeHeight(),o=document.getElementsByClassName("rc-ScribeCodeEditor"),d=o.length?o[0].offsetHeight:0;$(e).height(c+d)},h=function renderAceEditor(d,i){var C=i.innerText,u=i.getAttribute("data-language"),b=i.getAttribute("data-evaluator-id"),E=t&&t.context&&t.context.courseId,r=document.createElement("div");r.style.position="relative",r.setAttribute("class",o),s.appendChild(r);var m=document.createElement("div");r.appendChild(m);var p=document.createElement("div");r.appendChild(p);var c=new f({value:C,language:u,el:p,onChange:function onChange(e){return l.transactionManager.run(function(){return g.getCodeElementAtIndex(d).innerText=e})},onFocus:function onFocus(e){return l.trigger("content-changed")}});return i===g.focusedCodeElement&&setTimeout(function(){return c.editor.focus()},0),e.render(n.createElement(a,{aceEditor:c,languageValue:u,evaluatorId:b,courseId:E,onRemove:function onRemove(){return A(d)},onChange:function onChange(e,n,t){return S(d,e,n,t)}}),m),c},x=function removeAceEditors(){$("."+o,s).remove(),g.clearAceEditorCache()},C=function update(n){if(f){var e=g.getAllCodeElements();e.length!==_(g.aceEditors).values().length&&x(),e.map(function(n,t){var e=g.getAceEditorAtIndex(n);e||(e=h(n,t),g.setAceEditorAtIndex(e,n)),v(e,t)})}},y=function handleCreateCodeBlock(n){l.transactionManager.run(function(){var e=document.createElement("pre");e.setAttribute("data-language",n||""),u(l,m)?(m.nextSibling||m.parentNode.appendChild(document.createElement("p")),m.parentNode.replaceChild(e,m)):m.nextSibling?m.parentNode.insertBefore(e,m.nextSibling):(m.parentNode.appendChild(e),m.parentNode.appendChild(document.createElement("p"))),g.setFocusOnCodeElement(e)}),e.unmountComponentAtNode(p)},E=function handleCodeBlockCancel(){e.unmountComponentAtNode(p)};b.execute=function(){var r=new l.api.Selection,t=r.range;if(t){m=d(l,t.endContainer),p=document.createElement("div");var o=document.getElementsByClassName("rc-CMLEditorToolbar");if(!o.length)throw new Error('could not find element "scribe-toolbar-code" to append code language selector');o[0].appendChild(p),e.render(n.createElement(c,{onSelect:y,onCancel:E}),p)}},b.queryEnabled=function(){var e=new l.api.Selection,n=e.range;if(!n)return!1;return!0},b.queryState=function(){},r(function(e){f=e,C()}),l.on("content-changed",C),l.el.addEventListener("keydown",C),l.commands.code=b}}});